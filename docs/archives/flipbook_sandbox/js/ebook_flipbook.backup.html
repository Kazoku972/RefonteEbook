<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>On est ensemble, Maman - Story Mode</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <script src="jquery.min.js"></script>
    <script src="turn.min.js"></script>
    <link rel="stylesheet" href="css/story.css">
    <link rel="stylesheet" href="css/ebook_interactif.css">
    <style>
        /* Conteneurs : largeur/hauteur contrÃ´lÃ©es sans display:flex sur #flipbook (Instruction Espace Rouge) */
        html, body {
            margin: 0;
            padding: 0;
            width: 100% !important;
            height: 100% !important;
            min-height: 100% !important;
            overflow: hidden !important;
            background-color: #000;
        }

        #flipbook-viewport {
          width: 100% !important;
          height: auto !important;
          overflow: visible !important;
          display: block !important;
          margin: 0 !important;
          padding: 0 !important;
        }

        #flipbook {
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
          display: block !important;
          margin: 0 !important;
          visibility: hidden;
        }

        #flipbook .turn-page,
        #flipbook .flip-page,
        #flipbook .page {
          max-width: 100% !important;
          height: auto !important;
          box-sizing: border-box !important;
        }

    </style>
</head>
<body>

    .flip-page:not(.page-1), 
    .flip-page:not(.page-1) .page-content {
        background-color: #F9F7F2 !important; /* Sable pour tout sauf couv */
    }

    .flip-page, 
    .flip-page .page-content {
        width: 480px !important;
        height: 720px !important;
        position: relative !important;
        overflow: hidden !important;
    }

    /* STYLE UNIFIÃ‰ - DESIGN EBOOK GRATUIT */
    .page-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 24px !important;
        box-sizing: border-box;
        text-align: center;
        font-family: 'Plus Jakarta Sans', sans-serif;
        color: #5D5D5D; /* Gris Doux */
    }

    .page-content img {
        max-width: 100%;
        max-height: 50% !important;
        object-fit: contain;
        margin: 15px 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        border: 2px solid #FFFFFF; /* Bordure "Photo papier" */
        border-radius: 16px;
        position: relative !important; /* Reset position absolute de la couverture */
        top: auto !important;
        left: auto !important;
        width: auto !important;
        height: auto !important;
    }

    .page-overlay, .quote, .alert-box {
        width: 100% !important;
        display: block !important;
        z-index: 5000 !important;
        box-sizing: border-box;
        margin-top: auto; 
    }

    .flip-page:not(.page-1) .page-overlay {
        position: relative !important; 
        bottom: 0 !important;
        background: transparent !important;
        padding: 0 !important;
        border: none !important;
        box-shadow: none !important;
        z-index: 5 !important;
    }

    .flip-page:not(.page-1) .page-overlay h1, 
    .flip-page:not(.page-1) .page-overlay h2 {
        font-family: 'Playfair Display', serif;
        margin: 10px 0;
        color: #E8A3A8 !important; /* Rose PoudrÃ© */
        text-shadow: none !important; /* Pas de glow sur le contenu */
        animation: none !important;
        text-transform: none;
        letter-spacing: normal;
        font-size: clamp(24px, 5vw, 32px);
    }

    .page-overlay p {
        font-size: clamp(14px, 4vw, 18px);
        line-height: 1.6;
        margin: 10px 0;
    }

    .quote {
        font-family: 'Playfair Display', serif;
        font-style: italic;
        font-size: clamp(22px, 6vw, 30px);
        color: #E8A3A8 !important;
        border: none !important;
        background: transparent !important;
        padding: 40px 20px !important;
        position: relative;
    }

    .quote::before {
        content: "â€œ";
        font-size: 80px;
        color: rgba(232, 163, 168, 0.2);
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
    }

    .alert-box {
        background: #FFFFFF !important; /* Fond carte blanche */
        border: none !important;
        border-left: 4px solid #B7C6B0 !important; /* Bordure Sauge */
        border-radius: 24px;
        padding: 24px !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        text-align: left;
    }

    .alert-box h2 {
        font-family: 'Plus Jakarta Sans', sans-serif;
        color: #B7C6B0 !important; /* Sauge */
        font-size: 18px;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 10px;
    }


    /* CYCLE 2 - DESIGN COUVERTURE PREMIUM */
    .page-1,
    .page-1 .page-content {
        padding: 0 !important; /* Full bleed total */
        background: #000 !important;
        margin: 0 !important;
    }
    .page-1 img {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important; /* Immersif total */
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        z-index: 1 !important;
    }
    .page-1 .page-overlay {
        z-index: 10 !important;
        bottom: 100px !important;
        background: linear-gradient(transparent, rgba(0,0,0,0.8) 20%, rgba(0,0,0,0.9) 100%) !important;
        border: none !important;
        padding: 40px 10px !important;
    }
    .page-1 .page-overlay h1 {
        color: #fff !important;
        text-shadow: 0 0 20px rgba(233, 30, 99, 0.8);
        font-size: 28px !important;
        letter-spacing: 3px !important;
        animation: pulse-glow 3s infinite ease-in-out;
    }

    @keyframes pulse-glow {
        0% { text-shadow: 0 0 10px rgba(233, 30, 99, 0.5); }
        50% { text-shadow: 0 0 30px rgba(233, 30, 99, 1); }
        100% { text-shadow: 0 0 10px rgba(233, 30, 99, 0.5); }
    }
</style>

<div id="flipbook-viewport">
    <div id="flipbook">
        <!-- COUVERTURE -->
        <div class="flip-page hard page-1">
            <div class="page-content">
                <img src="../images/couverture.png" alt="Couverture">
                <div class="page-overlay">
                    <h1>On est ensemble, Maman</h1>
                </div>
            </div>
        </div>
        <!-- PAGE 2 -->
        <div class="flip-page">
            <div class="page-content">
                <img src="../images/ScÃ¨ne RÃ©veil Matin Chaotique.png" alt="Matin">
                <div class="page-overlay">
                    <h2>Avant-propos</h2>
                </div>
            </div>
        </div>
        <!-- PAGE 3 -->
        <div class="flip-page">
            <div class="page-content">
                <div class="quote">"Tu n'es pas seule."</div>
            </div>
        </div>
        <!-- PAGE 4 -->
        <div class="flip-page">
            <div class="page-content">
                <img src="../images/Illustration 1.1 - La remise en perspective (La guerriÃ¨re).png" alt="GuerriÃ¨re">
                <div class="page-overlay">
                    <h2>1. La GuerriÃ¨re</h2>
                </div>
            </div>
        </div>
        <!-- PAGE 5 -->
        <div class="flip-page">
            <div class="page-content">
                <div class="alert-box">
                    <h2>Ã€ retenir</h2>
                    <p>Maman, on est ensemble.</p>
                </div>
            </div>
        </div>
        <!-- PAGE 6 -->
        <div class="flip-page">
            <div class="page-content">
                <img src="../images/Illustration 6.1 - Le miroir bienveillant (Auto-affirmation).png" alt="Miroir">
                <div class="page-overlay">
                    <h2>ðŸŒŸ Ã‰quilibre</h2>
                </div>
            </div>
        </div>
        <!-- PAGE 7 -->
        <div class="flip-page conclusion">
            <div class="page-content">
                <img src="../images/ScÃ¨ne Coucher Tendre.png" alt="Coucher">
                <div class="page-overlay">
                    <h2>Marine ðŸ’•</h2>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function() {
        var flipbook = $('#flipbook');
        
        // TAILLES DE RÃ‰FÃ‰RENCE (STRATÃ‰GIE MASTER SCALE)
        var pageW = 480;
        var pageH = 720;
        
        // JS DE REDIMENSIONNEMENT DANS Lâ€™IFRAME (Instruction Espace Rouge)
        var pageRatio = 0.75; // Ratio cible pour iPhone SE (375 / 500 = 0.75)

        function resizeFlipbookToTarget(widthPx, heightPx) {
            if (!flipbook.length) return;
            try {
                if (typeof flipbook.turn === 'function') {
                    flipbook.turn('size', widthPx, heightPx);
                    try { flipbook.turn('resize'); } catch(e){}
                    flipbook.css('visibility', 'visible');
                    return;
                }
            } catch(e){}
            flipbook.css({ width: widthPx + 'px', height: heightPx + 'px', 'visibility': 'visible' });
        }

        function computeAndApply(targetRect) {
            if (targetRect && targetRect.width && targetRect.height) {
                resizeFlipbookToTarget(targetRect.width, targetRect.height);
            } else {
                var w = document.documentElement.clientWidth || window.innerWidth;
                var h = Math.round(w / pageRatio);
                resizeFlipbookToTarget(w, h);
            }
        }

        // API publique pour tests automatisÃ©s
        window.applyFlipbookTargetRect = function(rect){ computeAndApply(rect); };

        const urlParams = new URLSearchParams(window.location.search);
        const startPage = parseInt(urlParams.get('startpage')) || 1;

        flipbook.turn({
            width: pageW * 2,
            height: pageH,
            page: startPage,
            autoCenter: true, 
            display: ($(window).width() < 900) ? 'single' : 'double',
            acceleration: true,
            gradients: true,
            elevation: 50,
            duration: 600
        });

        $(window).resize(() => setTimeout(() => computeAndApply(null), 150));
        computeAndApply(null);
        setTimeout(() => computeAndApply(null), 500); // Consolidation stable
        $(document).on('turned', '#flipbook', () => setTimeout(() => computeAndApply(null), 100));

        if (window.MutationObserver) {
            var mo = new MutationObserver(() => setTimeout(() => computeAndApply(null), 80));
            mo.observe(document.getElementById('flipbook'), { childList: true });
        }

        // TOUCH HANDLING V3 - SENSIBILITÃ‰ ACCRUE
        var ts;
        flipbook.on('touchstart', function(e) { 
            ts = e.originalEvent.touches[0].pageX; 
        });
        flipbook.on('touchend', function(e) {
            var te = e.originalEvent.changedTouches[0].pageX;
            var diff = ts - te;
            if (Math.abs(diff) > 30) { // SensibilitÃ© de 30px au lieu de 50px
                if (diff > 0) flipbook.turn('next');
                else flipbook.turn('previous');
            }
        });

    });

    // ZOOM PREVENTION
    document.addEventListener('touchstart', function(e) { 
        if (e.touches.length > 1) e.preventDefault(); 
    }, { passive: false });
    
    var lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
        var now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) e.preventDefault();
        lastTouchEnd = now;
    }, false);
</script>

</body>
</html>
